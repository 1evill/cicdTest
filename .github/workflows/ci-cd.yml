# GitHub Actions CI/CD é…ç½®æ–‡ä»¶
# ç”¨äºè‡ªåŠ¨åŒ–æ„å»ºã€éƒ¨ç½² Vue3 + Vite é¡¹ç›®

name: Build and Deploy

# è®¾ç½®å¿…è¦çš„æƒé™
permissions:
  contents: write
  pages: write
  id-token: write

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: "20"

# å·¥ä½œæµç¨‹
jobs:
  # æ„å»ºå’Œéƒ¨ç½²ä½œä¸š
  build-and-deploy:
    name: æ„å»ºå’Œéƒ¨ç½²
    runs-on: ubuntu-latest

    # æ­¥éª¤å®šä¹‰
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šè®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      # æ­¥éª¤3ï¼šå®‰è£…é¡¹ç›®ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: npm ci

      # æ­¥éª¤4ï¼šè¿è¡Œç±»å‹æ£€æŸ¥å’Œæ„å»º
      - name: æ„å»ºé¡¹ç›®
        run: npm run build

      # æ­¥éª¤5ï¼šéƒ¨ç½²åˆ° GitHub Pagesï¼ˆä»…åœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶ï¼‰
      - name: éƒ¨ç½²åˆ° GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          # è§£å†³æƒé™é—®é¢˜
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com

      # æ­¥éª¤6ï¼šæ„å»ºçŠ¶æ€é€šçŸ¥
      - name: æ„å»ºå®Œæˆ
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "âœ… æ„å»ºæˆåŠŸå¹¶å·²éƒ¨ç½²åˆ° GitHub Pages"
            echo "ğŸŒ ç½‘ç«™åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          else
            echo "âœ… PR æ„å»ºæˆåŠŸ"
          fi
